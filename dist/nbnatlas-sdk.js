/* @preserve
 * A JS SDK for NBN Atlas. https://nbnatlas.org/
 * Author: Helen Manders-Jones helenmandersjones@gmail.com
 */
!function(e,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports):"function"==typeof define&&define.amd?define(["exports"],s):s((e=e||self).NBNAtlas={})}(this,(function(e){"use strict";async function s(e){const s=new AbortController;setTimeout((()=>s.abort()),1e4);const t=await fetch(e,{signal:s.signal});if(t.status>=400)return Promise.reject({status:t.status,message:t.statusText,body:t.data});if(t.status>=200&&t.status<=202){return await t.json()}return{}}function t(e,s=" OR "){return e.map((e=>encodeURIComponent('"'+e+'"'))).join("OR")}const i={URL_RECORDS_WS:"https://records-ws.nbnatlas.org",URL_SPECIES_WS:"https://species-ws.nbnatlas.org",URL_LISTS_WS:"https://lists.nbnatlas.org"},n={BEAUTIFUL_BURIAL_GROUNDS:"cl273"},a={BEAUTIFUL_BURIAL_GROUNDS_SEEK_ADVICE:"dr2504",BEAUTIFUL_BURIAL_GROUNDS_DIGEST_TABLE:"dr2492",SENSITIVE_IN_ENGLAND:"dr2058",SENSITIVE_IN_WALES:"dr2067"};class c{async getBBGPlace(e){let s=this._buildGetPlaceUrl(e),t=await this._getJson(s);return this._buildBBGPlaceDTO(t)}async getBBGPlacesForAssetID(e){let s=`${i.URL_SPECIES_WS}/search?fq=idxtype:REGIONFEATURED&fq=id_s:${e}`,t=await this._getJson(s);return this._buildBBGAssetDTO(t)}_buildBBGPlaceDTO(e){let s=e.searchResults&&e.searchResults.results&&e.searchResults.results[0]?e.searchResults.results[0]:null;return s?{assetID:s.id_s,name:s.bbg_name_s}:[]}_buildBBGAssetDTO(e){let s=e.searchResults&&e.searchResults.results&&e.searchResults.results.length>0?e.searchResults.results:null;return s?{assetID:s[0].id_s,assetName:s[0].name_s,places:s.map((e=>e.bbg_name_s))}:{}}_buildGetPlaceUrl(e){return`${i.URL_SPECIES_WS}/search?fq=idxtype:REGIONFEATURED&fq=name:${encodeURIComponent('"'+e+'"')}`}_getJson(e){return s(e)}}const r="Missing place name",u="Missing species list id",o="Missing asset id";function l(e){return Promise.reject({status:"INVALID",message:e})}class p{async getSpeciesCountByGroup({layerId:e,placeName:s}){"string"==typeof s&&(s=[s]);let n=`${i.URL_RECORDS_WS}/explore/groups?q=*:*&fq=${e}:(${t(s)})&fq=-occurrence_status:absent`,a=await this._getJson(n);return this._buildSpeciesCountByGroupDTO(a)}async getSpeciesCountByGroupForSpeciesList({layerId:e,placeName:s,speciesListId:n}){"string"==typeof s&&(s=[s]);let a=`${i.URL_RECORDS_WS}/explore/groups?q=*:*&fq=${e}:(${t(s)})&fq=-occurrence_status:absent`;a=`${a}&fq=species_list_uid:${n}`;let c=await this._getJson(a);return this._buildSpeciesCountByGroupDTO(c)}async getOccurrenceCount({layerId:e,placeName:s}){"string"==typeof s&&(s=[s]);const n=`${i.URL_RECORDS_WS}/occurrences/search?q=${e}:(${t(s)})&facets=names_and_lsid&pageSize=1&flimit=-1\n                                &fq=-occurrence_status:absent&sort=year&dir=desc&fl=year`,a=await this._getJson(n);return this._buildOccurrenceCountDTO(a)}async getOccurrenceCountForSpeciesList({layerId:e,placeName:s,speciesListId:n}){"string"==typeof s&&(s=[s]);const a=`${i.URL_RECORDS_WS}/occurrences/search?q=${e}:(${t(s)})&facets=names_and_lsid&pageSize=1&flimit=-1\n                            &fq=-occurrence_status:absent&fq=species_list_uid:${n}&sort=year&dir=desc&fl=year`,c=await this._getJson(a);return this._buildOccurrenceCountDTO(c)}_buildSpeciesCountByGroupDTO(e){return e}_buildOccurrenceCountDTO(e){return e.facetResults&&e.facetResults[0]&&e.facetResults[0].fieldResult?e.facetResults[0].fieldResult.map((e=>{const s=e.label.split("|");return{...e,additional:{scientificName:s[0],commonName:s[2],taxonGuid:s[1]}}})):[]}_getJson(e){return s(e)}}class S{async getSpeciesList(e){let t=`${i.URL_LISTS_WS}/ws/speciesListItems/${e}`,n=await s(t);return this._buildSpeciesListDTO(n)}_buildSpeciesListDTO(e){return e}}class _{constructor(e){this.layerId=e,this.recordsWS=new p,this.listsWS=new S}async getSpeciesCountByGroup(e,s){if(!e)return l(r);const t=await this.recordsWS.getSpeciesCountByGroup({layerId:this.layerId,placeName:e});let i=s?await this.recordsWS.getSpeciesCountByGroupForSpeciesList({layerId:this.layerId,placeName:e,speciesListId:s}):[];return this._buildSpeciesCountByGroupResult(t,i)}async getOccurrenceCount(e){if(!e)return l(r);let s=[];const t=await this.recordsWS.getOccurrenceCount({layerId:this.layerId,placeName:e});if(t){const e=await this.listsWS.getSpeciesList(a.SENSITIVE_IN_WALES),i=await this.listsWS.getSpeciesList(a.SENSITIVE_IN_ENGLAND);s=this._buildOccurrenceCountResult(t,e,i)}return s}async getOccurrenceCountForSpeciesList(e,s){if(!e)return l(r);if(!s)return l(u);const t=await this.listsWS.getSpeciesList(s);let i=[];const n=await this.recordsWS.getOccurrenceCountForSpeciesList({layerId:this.layerId,placeName:e,speciesListId:s});if(alert(JSON.stringify(n)),n){const e=await this.listsWS.getSpeciesList(a.SENSITIVE_IN_WALES),s=await this.listsWS.getSpeciesList(a.SENSITIVE_IN_ENGLAND);i=this._buildOccurrenceCountForSpeciesListResult(t,n,e,s)}return i}_buildSpeciesCountByGroupResult(e,s){const t=new Map;return e.forEach((e=>t.set(e.name,{speciesGroup:e.name,speciesCount:e.speciesCount,selectedSpeciesCount:0}))),s.forEach((e=>{let s=t.get(e.name);s?s={...s,selectedSpeciesCount:e.speciesCount}:t.set(e.name,{speciesGroup:e.name,speciesCount:0,selectedSpeciesCount:e.speciesCount})})),[...t.values()]}_buildOccurrenceCountResult(e,s,t){if(!e)return{};const i=this._sensitiveSpeciesJSONToMap(s),n=this._sensitiveSpeciesJSONToMap(t);return e.map((e=>({scientificName:e.additional.scientificName,commonName:e.additional.commonName,taxonGuid:e.additional.taxonGuid,count:e.count,sensitiveInEngland:!!i[e.additional.taxonGuid],sensitiveInWales:!!n[e.additional.taxonGuid]})))}_buildOccurrenceCountForSpeciesListResult(e,s,t,i){if(!s)return{};const n=this._sensitiveSpeciesJSONToMap(t),a=this._sensitiveSpeciesJSONToMap(i);return e.map((e=>({scientificName:e.scientificName,commonName:e.commonName,taxonGuid:e.lsid,count:this._getOccurrenceCount(e.lsid,s),sensitiveInEngland:!!n[e.lsid],sensitiveInWales:!!a[e.lsid]})))}_getOccurrenceCount(e,s){let t=0;return s.some((s=>s.additional.taxonGuid===e&&(t=s.count,!0))),t}_sensitiveSpeciesJSONToMap(e){return e.reduce(((e,s)=>(e[s.lsid]=s,e)),{})}}class d{constructor(){this.places=new _(n.BEAUTIFUL_BURIAL_GROUNDS),this.speciesWS=new c}async getSeekAdviceData(e){return this.places.getOccurrenceCountForSpeciesList(e,a.BEAUTIFUL_BURIAL_GROUNDS_SEEK_ADVICE)}async getSeekAdviceDataForAssetID(e){if(!e)return l(o);let s=await this.speciesWS.getBBGPlacesForAssetID(e);console.log(s);let t=await this.places.getOccurrenceCountForSpeciesList(s.places,a.BEAUTIFUL_BURIAL_GROUNDS_SEEK_ADVICE);return{assetID:(await s).assetID,assetName:(await s).assetName,counts:t}}async getDigestTableData(e){return this.places.getSpeciesCountByGroup(e,a.BEAUTIFUL_BURIAL_GROUNDS_DIGEST_TABLE)}async getDigestTableDataForAssetID(e){if(!e)return l(o);let s=await this.speciesWS.getBBGPlacesForAssetID(e),t=await this.places.getSpeciesCountByGroup(s.places,a.BEAUTIFUL_BURIAL_GROUNDS_DIGEST_TABLE);return{assetID:(await s).assetID,assetName:(await s).assetName,counts:t}}async getPlace(e){return e?await this.speciesWS.getBBGPlace(e):l(r)}}const I=new d;e.BBG=d,e.CONFIG=i,e.LAYERS=n,e.Places=_,e.SPECIES_LIST=a,e.bbg=I,e.places=function(e){return new _(e)},Object.defineProperty(e,"__esModule",{value:!0});var g=window.NBNAtlas;e.noConflict=function(){return window.NBNAtlas=g,this},window.NBNAtlas=e}));
//# sourceMappingURL=nbnatlas-sdk.js.map
