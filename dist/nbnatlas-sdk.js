/* @preserve
 * A JS SDK for NBN Atlas. https://nbnatlas.org/
 * Author: Helen Manders-Jones helenmandersjones@gmail.com
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).NBNAtlas={})}(this,(function(e){"use strict";async function t(e){const t=new AbortController;setTimeout((()=>t.abort()),1e4);const s=await fetch(e,{signal:t.signal});if(s.status>=400)return Promise.reject({status:s.status,message:s.statusText,body:s.data});if(s.status>=200&&s.status<=202){return await s.json()}return{}}const s={URL_RECORDS_WS:"https://records-ws.nbnatlas.org",URL_SPECIES_WS:"https://species-ws.nbnatlas.org",URL_LISTS_WS:"https://lists.nbnatlas.org"},i={BEAUTIFUL_BURIAL_GROUNDS:"cl273"},n={BEAUTIFUL_BURIAL_GROUNDS_SEEK_ADVICE:"dr2504",BEAUTIFUL_BURIAL_GROUNDS_DIGEST_TABLE:"dr2492",SENSITIVE_IN_ENGLAND:"dr2058",SENSITIVE_IN_WALES:"dr2067"};class c{async getBBGPlace(e){let t=this._buildGetPlaceUrl(e),s=await this._getJson(t);return this._buildBBGPlaceDTO(s)}_buildBBGPlaceDTO(e){let t=e.searchResults&&e.searchResults.results&&e.searchResults.results[0]?e.searchResults.results[0]:null;return t?{assetID:t.bbg_unique_s,name:t.bbg_name_s}:[]}_buildGetPlaceUrl(e){return`${s.URL_SPECIES_WS}/search?fq=idxtype:REGIONFEATURED&fq=name:${encodeURIComponent('"'+e+'"')}`}_getJson(e){return t(e)}}const a="Missing place name",r="Missing species list id";function u(e){return Promise.reject({status:"INVALID",message:e})}class o{async getSpeciesCountByGroup({layerId:e,placeName:t}){let i=`${s.URL_RECORDS_WS}/explore/groups?q=*:*&fq=${e}:${encodeURIComponent('"'+t+'"')}&fq=-occurrence_status:absent`,n=await this._getJson(i);return this._buildSpeciesCountByGroupDTO(n)}async getSpeciesCountByGroupForSpeciesList({layerId:e,placeName:t,speciesListId:i}){let n=`${s.URL_RECORDS_WS}/explore/groups?q=*:*&fq=${e}:${encodeURIComponent('"'+t+'"')}&fq=-occurrence_status:absent`;n=`${n}&fq=species_list_uid:${i}`;let c=await this._getJson(n);return this._buildSpeciesCountByGroupDTO(c)}async getOccurrenceCount({layerId:e,placeName:t}){const i=`${s.URL_RECORDS_WS}/occurrences/search?q=${e}:${encodeURIComponent('"'+t+'"')}&facets=names_and_lsid&pageSize=0&flimit=-1`,n=await this._getJson(i);return this._buildOccurrenceCountDTO(n)}async getOccurrenceCountForSpeciesList({layerId:e,placeName:t,speciesListId:i}){const n=`${s.URL_RECORDS_WS}/occurrences/search?q=${e}:${encodeURIComponent('"'+t+'"')}&facets=names_and_lsid&pageSize=0&flimit=-1&fq=-occurrence_status:absent&fq=species_list_uid:${i}`,c=await this._getJson(n);return this._buildOccurrenceCountDTO(c)}_buildSpeciesCountByGroupDTO(e){return e}_buildOccurrenceCountDTO(e){return e.facetResults&&e.facetResults[0]&&e.facetResults[0].fieldResult?e.facetResults[0].fieldResult.map((e=>{const t=e.label.split("|");return{...e,additional:{scientificName:t[0],commonName:t[2],taxonGuid:t[1]}}})):[]}_getJson(e){return t(e)}}class l{async getSpeciesList(e){let i=`${s.URL_LISTS_WS}/ws/speciesListItems/${e}`,n=await t(i);return this._buildSpeciesListDTO(n)}_buildSpeciesListDTO(e){return e}}class p{constructor(e){this.layerId=e,this.recordsWS=new o,this.listsWS=new l}async getSpeciesCountByGroup(e,t){if(!e)return u(a);const s=await this.recordsWS.getSpeciesCountByGroup({layerId:this.layerId,placeName:e});let i=t?await this.recordsWS.getSpeciesCountByGroupForSpeciesList({layerId:this.layerId,placeName:e,speciesListId:t}):[];return this._buildSpeciesCountByGroupResult(s,i)}async getOccurrenceCount(e){if(!e)return u(a);let t=[];const s=await this.recordsWS.getOccurrenceCount({layerId:this.layerId,placeName:e});if(s){const e=await this.listsWS.getSpeciesList(n.SENSITIVE_IN_WALES),i=await this.listsWS.getSpeciesList(n.SENSITIVE_IN_ENGLAND);t=this._buildOccurrenceCountResult(s,e,i)}return t}async getOccurrenceCountForSpeciesList(e,t){if(!e)return u(a);if(!t)return u(r);const s=await this.listsWS.getSpeciesList(t);let i=[];const c=await this.recordsWS.getOccurrenceCountForSpeciesList({layerId:this.layerId,placeName:e,speciesListId:t});if(c){const e=await this.listsWS.getSpeciesList(n.SENSITIVE_IN_WALES),t=await this.listsWS.getSpeciesList(n.SENSITIVE_IN_ENGLAND);i=this._buildOccurrenceCountForSpeciesListResult(s,c,e,t)}return i}_buildSpeciesCountByGroupResult(e,t){const s=new Map;return e.forEach((e=>s.set(e.name,{speciesGroup:e.name,speciesCount:e.speciesCount,selectedSpeciesCount:0}))),t.forEach((e=>{let t=s.get(e.name);t?t={...t,selectedSpeciesCount:e.speciesCount}:s.set(e.name,{speciesGroup:e.name,speciesCount:0,selectedSpeciesCount:e.speciesCount})})),[...s.values()]}_buildOccurrenceCountResult(e,t,s){if(!e)return{};const i=this._sensitiveSpeciesJSONToMap(t),n=this._sensitiveSpeciesJSONToMap(s);return e.map((e=>({scientificName:e.additional.scientificName,commonName:e.additional.commonName,taxonGuid:e.additional.taxonGuid,count:e.count,sensitiveInEngland:!!i[e.additional.taxonGuid],sensitiveInWales:!!n[e.additional.taxonGuid]})))}_buildOccurrenceCountForSpeciesListResult(e,t,s,i){if(!t)return{};const n=this._sensitiveSpeciesJSONToMap(s),c=this._sensitiveSpeciesJSONToMap(i);return e.map((e=>({scientificName:e.scientificName,commonName:e.commonName,taxonGuid:e.lsid,count:this._getOccurrenceCount(e.lsid,t),sensitiveInEngland:!!n[e.lsid],sensitiveInWales:!!c[e.lsid]})))}_getOccurrenceCount(e,t){let s=0;return t.some((t=>t.additional.taxonGuid===e&&(s=t.count,!0))),s}_sensitiveSpeciesJSONToMap(e){return e.reduce(((e,t)=>(e[t.lsid]=t,e)),{})}}class d{constructor(){this.places=new p(i.BEAUTIFUL_BURIAL_GROUNDS),this.speciesWS=new c}async getSeekAdviceData(e){return this.places.getOccurrenceCountForSpeciesList(e,n.BEAUTIFUL_BURIAL_GROUNDS_SEEK_ADVICE)}async getDigestTableData(e){return this.places.getSpeciesCountByGroup(e,n.BEAUTIFUL_BURIAL_GROUNDS_DIGEST_TABLE)}async getPlace(e){return e?await this.speciesWS.getBBGPlace(e):u(a)}}const S=new d;e.BBG=d,e.CONFIG=s,e.LAYERS=i,e.Places=p,e.SPECIES_LIST=n,e.bbg=S,e.places=function(e){return new p(e)},Object.defineProperty(e,"__esModule",{value:!0});var _=window.NBNAtlas;e.noConflict=function(){return window.NBNAtlas=_,this},window.NBNAtlas=e}));
//# sourceMappingURL=nbnatlas-sdk.js.map
